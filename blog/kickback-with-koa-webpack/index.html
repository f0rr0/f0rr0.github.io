<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Kickback With Koa &amp; Webpack - Yuppies</title><meta name="robots" content="index, follow"/><meta name="author" content="Siddharth Jain"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@f0rr0"/><meta name="twitter:title" content="Kickback With Koa &amp; Webpack - Yuppies"/><meta name="twitter:description" content="Written by Siddharth Jain ‚Äî an open source developer interested in minimal design, advanced JavaScript and everything Œª. He is currently available for contract development on a project basis."/><meta property="og:title" content="Kickback With Koa &amp; Webpack - Yuppies"/><meta property="og:type" content="article"/><meta property="og:url" content="https://yuppi.es/blog/kickback-with-koa-webpack/"/><meta property="og:description" content="Written by Siddharth Jain ‚Äî an open source developer interested in minimal design, advanced JavaScript and everything Œª. He is currently available for contract development on a project basis."/><meta property="og:site_name" content="Yuppies"/><meta property="article:author" content="https://facebook.com/f0rr0"/><meta property="og:image" content="https://yuppi.es/avatar.jpeg"/><link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet"/><style>*{margin:0;padding:0;border:none;box-sizing:border-box}article,aside,footer,header,hgroup,nav,section,time{display:block}html{height:100%;background:#21232d;color:#d8d8d6;font-family:Inconsolata,Andale Mono,PT Mono,Courier New,monospace;font-size:18px;line-height:1.5}@media screen and (max-width:600px){html{font-size:16px}}body{height:100%;width:700px;margin:0 auto}@media screen and (max-width:800px){body{width:88%}}#react-mount{height:100%}main{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;min-height:100%}.content{-ms-flex:1 0 auto;flex:1 0 auto}ol,p,pre,table,ul{padding-bottom:1.125em}li ol{padding-left:1.82em}li ol,li ul{padding-bottom:0}li ul{padding-left:1em}h1,h2,h3,h4,h5,h6{padding-bottom:.37em;line-height:1.125}h1{font-size:2.027em}h2{font-size:1.62em}h3{font-size:1.424em}h4{font-size:1.266em}h5{font-size:1em}h6{font-size:.72em}small{font-size:.889em}a{color:#57c7ff;display:inline-block;text-decoration:none;position:relative;cursor:pointer}a:after{content:'';position:absolute;bottom:0;left:0;width:0;border-bottom:1px solid #57c7ff;transition:.4s ease-in-out;transition-delay:.1s}a:hover:after{width:100%;transition-delay:0s}del{text-decoration:line-through;color:#4d5068}hr{display:block;border-top:1px solid #424559;margin:1.125em 0 2em}::-moz-selection{color:#21232d;background:#d8d8d6;background-color:hsla(60,2%,84%,.996)}::selection{color:#21232d;background-color:hsla(60,2%,84%,.996)}img::-moz-selection{background-color:hsla(60,2%,84%,.5)}img::selection{background-color:hsla(60,2%,84%,.5)}.post-list time{width:6.583em}.blog-header{padding-bottom:1.125em}.blog-header h2{padding-bottom:.216em}.blog-header time{display:inline}.blog-header div{font-size:.889em}.blog-body h1,.blog-body h2,.blog-body h3,.blog-body h4,.blog-body h5,.blog-body h6{color:#f92672}.header-anchor{display:none;opacity:0;margin-left:-1em;transition:opacity .5s ease-in-out;color:inherit!important}.header-anchor:after{border:none}.emoji{display:inline-block;box-sizing:content-box;width:1rem;height:1rem;vertical-align:-.15em}.post-content h1,.post-content h2,.post-content h3,.post-content h4,.post-content h5,.post-content h6{padding-bottom:.216em}.post-content h1 .header-anchor,.post-content h2 .header-anchor,.post-content h3 .header-anchor,.post-content h4 .header-anchor,.post-content h5 .header-anchor,.post-content h6 .header-anchor{display:inline}@media screen and (max-width:600px){.post-content h1 .header-anchor,.post-content h2 .header-anchor,.post-content h3 .header-anchor,.post-content h4 .header-anchor,.post-content h5 .header-anchor,.post-content h6 .header-anchor{display:none}}.post-content h1:hover .header-anchor,.post-content h2:hover .header-anchor,.post-content h3:hover .header-anchor,.post-content h4:hover .header-anchor,.post-content h5:hover .header-anchor,.post-content h6:hover .header-anchor{opacity:.9}.post-content code{font-size:.889em;background:#1d1f21;color:#c5c8c6;font-family:Menlo,Monaco,Consolas,monospace;display:inline-block;padding:0 .5em;border-radius:5px;box-shadow:inset 0 1px 3px rgba(0,0,0,.3),0 .75px 0 rgba(53,56,73,.4)}@media screen and (max-width:600px){.post-content code{font-size:14px}}.post-content pre code{display:block;padding:1.266em;white-space:pre;overflow:scroll;box-shadow:inset 0 1px 10px rgba(0,0,0,.3),0 1px 0 rgba(53,56,73,.4),0 -1px 0 rgba(0,0,0,.3)}.post-content blockquote{padding:1.125em 2.566em;font-style:italic;position:relative;color:#f3f99d}.post-content blockquote:before{content:'\201C';font-size:400%;left:-12px;line-height:.5;position:absolute}.post-content blockquote ol,.post-content blockquote ul{list-style-position:inside}.post-content cite{display:block;padding-top:1.125em}.post-content cite:before{content:'\2014   '}.post-content figure{text-align:center;padding:1.82em 0 2.927em}.post-content figure a{display:inline;opacity:1;transition:all .4s ease-in-out}.post-content figure a:hover{opacity:.5}.post-content figure a:after,.post-content figure a:hover:after{display:none;content:none}.post-content figure img{display:block;max-width:100%;height:auto;margin:0 auto}.post-content figure.full-width img{min-width:100%}.post-content figure a~figcaption,.post-content img~figcaption{margin:10px 0 -10px;font-size:.889em;font-style:italic}.share-icons{display:inline-block;padding:0 .5em;cursor:pointer;opacity:1;transition:opacity .4s ease-in-out}.share-icons:first-child{padding-left:0}.share-icons:hover{opacity:.7}.post-footer>ul{padding:3px 0 1.125em;margin:1em 0;line-height:1;display:block}.post-footer>ul li{display:inline-block;list-style-type:none}.post-footer>article header{color:#f92672}.post-footer>article ul li{display:block;padding-bottom:10px}.post-footer>article ul li:last-child,.post-footer>article ul li>p{padding-bottom:0}.masthead{border-bottom:1px solid #424559;padding:1.62em 0;margin-bottom:1.62em;text-align:center}.masthead h1{padding-bottom:1rem}.masthead h1 a{font-size:51.957px;background-color:#f92672;color:#21232d;padding:5px 15px}.masthead li,.masthead nav,.masthead ul{display:inline-block;line-height:1;padding-bottom:0}.masthead a{color:#d8d8d6}.masthead a:after{content:none;border:none}.masthead li{margin:0 12px;list-style-type:none}.masthead li:first-child{margin-left:0}.masthead li:last-child{margin-right:0}footer{margin-top:1.125em;text-align:center;border-top:1px solid #424559}footer p,footer ul{padding:1.62rem 0;display:inline-block}@media screen and (max-width:415px){footer p,footer ul{display:block;width:100%}}footer p{font-size:16px;float:left}footer p .footer-icon{vertical-align:-.25rem}@media screen and (max-width:415px){footer p{padding-bottom:.5rem}}footer ul{float:right}@media screen and (max-width:415px){footer ul{padding-top:.5rem}}footer li{padding:0 4px;list-style-type:none;display:inline-block}@media screen and (max-width:415px){footer li{padding:0 7px}}footer a{color:#d8d8d6;opacity:.7;transition:all .4s ease-in-out}footer a:hover{opacity:1}footer a:after,footer a:hover:after{display:none;content:none;border:none}.footer-icon{height:16px;width:16.5px;background-size:cover;background-position:0 0;filter:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="filter"><feComponentTransfer color-interpolation-filters="sRGB"><feFuncR type="table" tableValues="1 0" /><feFuncG type="table" tableValues="1 0" /><feFuncB type="table" tableValues="1 0" /></feComponentTransfer><feComponentTransfer color-interpolation-filters="sRGB"><feFuncR type="linear" slope="0.85" /><feFuncG type="linear" slope="0.85" /><feFuncB type="linear" slope="0.85" /></feComponentTransfer></filter></svg>#filter');-webkit-filter:invert(100%) brightness(85%);filter:invert(100%) brightness(85%);display:inline-block;vertical-align:-.5px}@media screen and (max-width:415px){.footer-icon{height:16.5px;width:16.5px}}.bio{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;padding-bottom:1.125em}.bio .avatar{margin-right:1em;width:100px;border-radius:50%}.bio .intro{-ms-flex:1;flex:1;padding-bottom:0}@media screen and (max-width:600px){ol,ul{list-style-position:inside}}@media only screen and (min-device-width:320px) and (max-device-width:480px){.content a{display:inline}.content a:after,.content a:hover:after{content:none}.bio{display:block;overflow:auto;padding-bottom:1.125em}.bio .avatar{float:left;margin-right:1em;width:80px;border-radius:50%}.bio .intro{-ms-flex:1;flex:1;padding-bottom:0}}.hljs-comment,.hljs-quote{color:#969896}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c66c66}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#de935f}.hljs-attribute{color:#f0c674}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#b5bd68}.hljs-section,.hljs-title{color:#81a2be}.hljs-keyword,.hljs-selector-tag{color:#b294bb}.hljs{display:block;overflow-x:auto;background:#1d1f21;color:#c5c8c6;padding:.5em}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.lists{display:-ms-flexbox;display:flex;position:relative;font-size:18px}@media screen and (max-width:767px){.lists{display:block}}.list-intro{font-size:.79em;font-family:Menlo,Monaco,Consolas,monospace;padding-bottom:1em;transition:opacity .5s ease-in}@media screen and (max-width:767px){.list-intro{letter-spacing:-.75px}}.ellipsis{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}.activity-list,.track-list{-ms-flex:1 0 auto;flex:1 0 auto;margin:0;padding:0}.activity-list ul,.track-list ul{list-style-type:none!important;padding-bottom:1.5em}.track-list a:first-child .track{margin-top:0}.track-list a:last-child .track{margin-bottom:0}.activity-list .activity:first-child{margin-top:0}.activity-list .activity:last-child{margin-bottom:0}.activity-list .activity,.track-list .track{overflow:auto;overflow-x:hidden;position:relative;margin:12px 0;border-radius:3px;padding:5px;background:#2a2c3c;transition:opacity .5s ease-in,background .4s ease-in-out}.activity-list .activity .thumb,.track-list .track .thumb{width:80px;height:80px;border-radius:2px;background-size:cover;background-position:50%;background-color:#3e4256;float:left;margin-right:8px}.activity-list .activity .info,.track-list .track .info{position:absolute;top:50%;transform:translateY(-50%);padding-left:90px;padding-right:10px;width:97%}.track-list .thumb{box-shadow:inset 0 0 10px #000}.track-list .track:hover{background:#353849}.activity-list~.track-list{padding-left:2.027em}@media screen and (max-width:767px){.activity-list~.track-list{padding-left:0}}.activity-list .activity .icon{background-position:0 0;background-color:rgba(0,255,85,.01);filter:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="filter"><feComponentTransfer color-interpolation-filters="sRGB"><feFuncR type="table" tableValues="1 0" /><feFuncG type="table" tableValues="1 0" /><feFuncB type="table" tableValues="1 0" /></feComponentTransfer><feComponentTransfer color-interpolation-filters="sRGB"><feFuncR type="linear" slope="0.85" /><feFuncG type="linear" slope="0.85" /><feFuncB type="linear" slope="0.85" /></feComponentTransfer></filter></svg>#filter');-webkit-filter:invert(100%) brightness(85%);filter:invert(100%) brightness(85%);width:60px;height:60px;margin:10px 6px 10px 14px}.activity-list .category,.track-list .title{font-size:.79em}.activity-list time,.track-list .artist{font-size:.79em;padding-bottom:7px}.activity-list .activities,.track-list time{font-size:.72em}.track-list a{display:inherit;color:inherit}.track-list a:after{content:none}.activity-list .activities{font-style:italic}.equaliser-container{margin-top:5px;margin-bottom:3px;font-size:10px;height:1em;position:relative}.equaliser-container .equaliser-column{width:2px;float:left;margin:0 1px 0 0;padding:0;height:1em;position:relative;list-style-type:none}.equaliser-container .equaliser-column .colour-bar{position:absolute;left:0;right:0;bottom:0;height:1em;background:#d8d8d6}.equaliser-container .equaliser-column:nth-child(1) .colour-bar{animation:color-bar 2s 1s ease-out alternate infinite}.equaliser-container .equaliser-column:nth-child(2) .colour-bar{animation:color-bar 2s .5s ease-out alternate infinite}.equaliser-container .equaliser-column:nth-child(3) .colour-bar{animation:color-bar 2s 1.5s ease-out alternate infinite}.equaliser-container .equaliser-column:nth-child(4) .colour-bar{animation:color-bar 2s .25s ease-out alternate infinite}.equaliser-container .equaliser-column:nth-child(5) .colour-bar{animation:color-bar 2s 2s ease-out alternate infinite}.equaliser-container .equaliser-column:last-child{margin-right:0}@keyframes color-bar{0%{height:1em}10%{height:.3em}20%{height:.5em}30%{height:.2em}40%{height:.6em}50%{height:.8em}60%{height:.5em}70%{height:.7em}80%{height:1em}90%{height:.7em}to{height:.25em}}.loading{text-align:center;display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center;width:100%}.double-bounce,.loading p{display:inline-block}.double-bounce{width:27px;height:27px;margin:0 10px;position:relative}.double-bounce1,.double-bounce2{display:inline-block;width:100%;height:100%;border-radius:50%;background-color:#424559;opacity:.6;position:absolute;top:0;left:0;animation:bounce 2s infinite ease-in-out}.double-bounce2{animation-delay:-1s}@keyframes bounce{0%,to{transform:scale(0)}50%{transform:scale(1)}}.qs-appear{opacity:.01}.qs-appear.qs-appear-active{opacity:1;transition:opacity 1.2s ease-in-out}@media only screen and (min-device-width:320px) and (max-device-width:480px){.lists a{border-bottom:none}}</style></head><body class="container"><div id="react-mount"><main data-reactroot="" data-reactid="1" data-react-checksum="-859834394"><header class="masthead" data-reactid="2"><h1 data-reactid="3"><a href="/" data-reactid="4">YUPPI.ES</a></h1><nav data-reactid="5"><ul data-reactid="6"><li data-reactid="7"><a href="/about/" data-reactid="8">About</a></li><!-- react-text: 9 -->¬∑<!-- /react-text --><li data-reactid="10"><a href="/blog/" data-reactid="11">Blog</a></li><!-- react-text: 12 -->¬∑<!-- /react-text --><li data-reactid="13"><a href="/hire/" data-reactid="14">Hire Me</a></li></ul></nav></header><section class="content" data-reactid="15"><article class="blog-body" data-reactid="16"><header class="blog-header" data-reactid="17"><h2 data-reactid="18">Kickback With Koa &amp; Webpack</h2><div data-reactid="19"><time data-reactid="20">June 28, 2016</time><!-- react-text: 21 --> ¬∑ <!-- /react-text --><!-- react-text: 22 -->2502<!-- /react-text --><!-- react-text: 23 --> words ¬∑ <!-- /react-text --><!-- react-text: 24 -->13 min read<!-- /react-text --></div></header><div class="post-content" data-reactid="25"><figure class="full-width"><img src="./banner.png" alt="Written at Kerckhoff Coffee House ~ LA Westside"><figcaption>Written at Kerckhoff Coffee House ~ LA Westside</figcaption></figure>
<h4 id="yet-another-javascript-framework"><a class="header-anchor" href="#yet-another-javascript-framework" aria-hidden="true">¬ß</a> Yet Another JavaScript Framework?</h4>
<p><a href="https://nodejs.org/en/about/">Node.js</a> itself offers a
<a href="https://nodejs.org/docs/latest/doc/api/http.html#http_http">http</a> module which
exposes methods that facilitate creating HTTP clients and servers. However, in
order to support the full spectrum of possible HTTP applications, Node.js‚Äô HTTP
API is very low-level. This is where frameworks like
<a href="http://expressjs.com/">Express</a>, <a href="http://hapijs.com/">Hapi</a>,
<a href="http://restify.com/">Restify</a>, and <a href="http://koajs.com/">Koa</a> come in.</p>
<h4 id="quick-word-on-express"><a class="header-anchor" href="#quick-word-on-express" aria-hidden="true">¬ß</a> Quick Word on Express</h4>
<p>Express is undoubtedly the most popular Node.js application framework in use
today. A quick check reveals that 10434 packages on
<a href="https://www.npmjs.com/">npm</a> list Express as a dependency. This number probably
increases by the day. The initial commit for Express was made in 2009 by <a href="https://medium.com/u/bbb3c7ccb0a0">TJ
Holowaychuk</a> and 660 commits later, version
0.0.1 was released. Express ownership was transferred to StrongLoop, in 2014,
which eventually got acquired by IBM. The current lead maintainer of the project
<a href="https://github.com/expressjs/express/issues/2844#issuecomment-173758490">did not have many nice things to
say</a>
about StrongLoop/IBM.</p>
<h4 id="aloha-koa"><a class="header-anchor" href="#aloha-koa" aria-hidden="true">¬ß</a> Aloha Koa</h4>
<p>The initial commit for Koa was 3 years ago, by none other than the man himself ‚Äî
<a href="https://medium.com/u/bbb3c7ccb0a0">TJ Holowaychuk</a>. He described it back then
as:</p>
<blockquote>
<p>‚ÄúExpressive middleware for node.js using generators via
<a href="https://github.com/tj/co">co</a> to make writing web applications and REST APIs
more enjoyable to write‚Äù.</p>
</blockquote>
<p>Basically, Koa allows you to do away with the callback pattern and makes
error-handling more efficient. Everything in Koa is middleware which makes
writing code more intuitive and easy (at least for me). Koa accomplished this
with <a href="https://davidwalsh.name/es6-generators">generators</a> which were
introduced in <a href="http://www.ecma-international.org/ecma-262/6.0/">ES2015 (ES6)</a>.
This can be run natively in Node.js version 0.11+ (with the <code>--harmony</code> flag).
As of <a href="https://github.com/koajs/koa/blob/v2.x/History.md#200-alpha1--2015-10-22">version
2.0.0-alpha.1</a>,
however, the codebase was refactored to <a href="https://tc39.github.io/ecmascript-asyncawait/">async
functions</a> (<a href="https://tc39.github.io/ecma262/2016/">ES2016 or
ES7</a>) in favor of generators.
Unfortunately, these are <a href="https://bugs.chromium.org/p/v8/issues/detail?id=4483">not
supported</a> natively in
<a href="https://developers.google.com/v8/">V8</a> (underlying engine behind the Node.js
runtime) yet.</p>
<h4 id="tools-of-the-trade"><a class="header-anchor" href="#tools-of-the-trade" aria-hidden="true">¬ß</a> Tools of the Trade</h4>
<p>Since Node.js (V8) does not support <code>async</code> functions natively, we will use
<a href="https://babeljs.io/">Babel</a> to transpile them. JavaScript, as a language, is
constantly evolving with new specs and proposals coming out all the time. Babel
allows us to use these features years before they are available everywhere.</p>
<blockquote>
<p>Babel does this by compiling down JavaScript code written with the latest
standards into a version that will work in today‚Äôs environments. This process is
known as source-to-source compiling aka transpiling.</p>
</blockquote>
<p>To build our application, we will use the <a href="https://webpack.github.io/">Webpack</a>
module bundler which provides an infrastructure for building and transforming
modules. It is discussed in detail in the subsequent sections.</p>
<h4 id="talk-is-cheap-show-me-the-code"><a class="header-anchor" href="#talk-is-cheap-show-me-the-code" aria-hidden="true">¬ß</a> Talk is Cheap. Show Me the Code.</h4>
<p>The final GitHub repository is linked <a href="https://github.com/f0rr0/koa-webpack-boilerplate">here</a>. Before you begin hacking, make sure you have the latest version of Node.js
<a href="https://nodejs.org/en/">installed</a>. I prefer to use
<a href="https://github.com/tj/n">n</a> to interactively manage Node.js versions. (While
writing this, I discovered that the author of ‚Äôn‚Äô is <a href="https://medium.com/u/bbb3c7ccb0a0">TJ
Holowaychuk</a> yet again.)</p>
<pre><code class="language-sh">sudo npm cache clean <span class="hljs-_">-f</span>
sudo npm install -g n
sudo n latest
</code></pre>
<p>To use some npm commands without <code>sudo</code> you might have to <a href="https://docs.npmjs.com/getting-started/fixing-npm-permissions">fix
permissions</a>.</p>
<h4 id="boilerplate-for-boilerplate"><a class="header-anchor" href="#boilerplate-for-boilerplate" aria-hidden="true">¬ß</a> Boilerplate for Boilerplate</h4>
<p>We need to set up a minimal NPM package with a <code>package.json</code> file, a directory
for source, and certain essential files for our development tools.</p>
<figure><img src="./dirstructure.png" alt=""></figure>
<p>Go ahead and clone the final repository to your machine to build the minimal
server from source.</p>
<pre><code class="language-sh">git <span class="hljs-built_in">clone</span> https://github.com/f0rr0/koa-webpack-boilerplate
<span class="hljs-built_in">cd</span> koa-webpack-boilerplate
npm install
npm run build:prod
npm start
</code></pre>
<p>If you want to be articulate and follow from scratch, the following GIF will help:</p>
<figure><img src="./bootstrap.gif" alt=""></figure>
<h4 id="unbundling-webpack"><a class="header-anchor" href="#unbundling-webpack" aria-hidden="true">¬ß</a> Unbundling Webpack</h4>
<p>Webpack was authored by JavaScript superhero <a href="https://github.com/sokra">Tobias
Koppers</a>. It is used in the
<a href="http://stackshare.io/webpack/in-stacks#/">wild</a> at Pinterest, Hipmunk,
Soundcloud and Typeform among others. It is different from other build tools
(<a href="http://gruntjs.com/">Grunt</a>, <a href="http://gulpjs.com/">Gulp</a>,
<a href="http://brunch.io/">Brunch</a> etc.), that you might be familiar with, since it
does <strong>more</strong> than watching a path and running tasks on files.</p>
<blockquote>
<p>Webpack roams over your application source code, looking for import/require
statements, building a dependency graph, and emitting one (or more) <em>bundles</em>
for the web (<a href="https://webpack.github.io/docs/configuration.html#target">or other
targets</a>).</p>
</blockquote>
<figure><img src="./webpack.png" alt=""></figure>
<p>It may seem like you can use webpack with only JavaScript modules but that is
not true. With appropriate webpack
<a href="https://webpack.github.io/docs/loaders.html">loaders</a>, you can bundle any
file-type and pre-process it. Basically, what this means is, you can do the
following in your front-end application with the
<a href="https://github.com/webpack/css-loader">css-loader</a>:</p>
<pre><code class="language-js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'css!./styles/main.css'</span>);
</code></pre>
<p>If this does not make you run naked in the streets, then I don‚Äôt know what will.
You can even chain loaders to process files on the fly, like so:</p>
<pre><code class="language-js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'style!css!sass!./styles/main.sass'</span>);
</code></pre>
<p>This one-liner appropriately parses the SASS file to CSS and injects it into the DOM in a style tag. To learn more about webpack, read <a href="https://medium.com/u/3b799f227b58">Pete Hunt</a>‚Äôs <a href="https://github.com/petehunt/webpack-howto">webpack-howto</a>.</p>
<p>When used from the CLI, webpack looks for a configuration file named <code>webpack.config.js</code> in the directory from where webpack was invoked. You can also supply your config file using the <code>--config</code> option from the CLI. So let‚Äôs install webpack and set up the config file for our repository.</p>
<p>Note ‚Äî You can view and install specific <code>dist-tags</code> for a package on <code>npm</code> like so:</p>
<pre><code class="language-sh">npm view &lt;package-name&gt; dist-tags
npm install &lt;package-name&gt;@&lt;dist-tag&gt;
</code></pre>
<p>In the root directory of your repository:</p>
<pre><code class="language-sh">npm install -D webpack@beta
</code></pre>
<p>This installs webpack as a <strong>development dependency</strong> to your package. Beginning from version 2+, the webpack config file can export a function which returns the configuration. The function is called by the CLI and the value passed via <code>--env</code> from the CLI is passed to the configuration function. Our minimal <code>webpack.config.js</code> will look like so:</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> { resolve } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> { dependencies } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./package.json'</span>);
<span class="hljs-keyword">const</span> BabiliPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"babili-webpack-plugin"</span>);

<span class="hljs-keyword">const</span> nodeModules = {};

<span class="hljs-built_in">Object</span>
    .keys(dependencies)
    .forEach(<span class="hljs-function">(<span class="hljs-params">mod</span>) =&gt;</span> {
     nodeModules[mod] = <span class="hljs-string">`commonjs <span class="hljs-subst">${mod}</span>`</span>;
    });

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function">(<span class="hljs-params">env = { dev: <span class="hljs-literal">true</span> }</span>) =&gt;</span> ({
    <span class="hljs-attr">context</span>: resolve(__dirname, <span class="hljs-string">'./src'</span>),
    <span class="hljs-attr">entry</span>: {
     <span class="hljs-attr">server</span>: env.prod ? <span class="hljs-string">'./index.js'</span> : [<span class="hljs-string">'webpack/hot/poll?1000'</span>, <span class="hljs-string">'./index.js'</span>]
    },
    <span class="hljs-attr">target</span>: <span class="hljs-string">'node'</span>,
    <span class="hljs-attr">output</span>: {
     <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].js'</span>,
     <span class="hljs-attr">path</span>: resolve(__dirname, <span class="hljs-string">'./build'</span>),
     <span class="hljs-attr">pathInfo</span>: !env.prod
    },
    <span class="hljs-attr">devtool</span>: env.prod ? <span class="hljs-string">'source-map'</span> : <span class="hljs-string">'eval'</span>,
    <span class="hljs-attr">module</span>: {
     <span class="hljs-attr">loaders</span>: [
       {
         <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
         <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,
         <span class="hljs-attr">loaders</span>: [
           <span class="hljs-string">'babel-loader'</span>
         ]
       }
     ]
    },
    <span class="hljs-attr">plugins</span>: env.prod ? [
      <span class="hljs-keyword">new</span> BabiliPlugin()
    ] : [],
    <span class="hljs-attr">externals</span>: nodeModules
});
</code></pre>
<p>The various configuration options are well documented
<a href="http://webpack.github.io/docs/configuration.html#configuration-object-content">here</a>.
I‚Äôll explain a couple of quirks related to a non-browser environment below:</p>
<ul>
<li><strong>externals:</strong> When writing a server and bundling it with webpack, we don‚Äôt want our dependencies to be resolved by webpack. Instead, they will become the dependencies of the bundle we generate. To accomplish this, we pull our dependencies from the <code>package.json</code> file and prefix them with <code>commonjs</code>. The Webpack generated import code for a prefixed fictional dependency named <code>xyz</code> will then look like so:</li>
</ul>
<pre><code class="language-js"><span class="hljs-built_in">module</span>.exports = <span class="hljs-built_in">require</span>(<span class="hljs-string">"xyz"</span>);
</code></pre>
<p>To ensure that this behaviour is consistent, install dependencies with the <code>-S</code>
or <code>--save</code> option.</p>
<ul>
<li><strong>target:</strong> Setting the target for our bundle to <em>node</em> compiles our modules to be run in a Node.js like environment. What this does is essentially the same as above. It prepends all native modules available in the current Node.js environment with <code>commonjs</code>. Internally, the names of all such modules available to the current process are obtained by:</li>
</ul>
<pre><code class="language-sh">process.binding(<span class="hljs-string">"natives"</span>);
</code></pre>
<p>This returns an object with all the native modules like <code>dns</code>, <code>domain</code>, <code>events</code>, <code>fs</code>, <code>http</code> etc.</p>
<h4 id="dabble-in-babel"><a class="header-anchor" href="#dabble-in-babel" aria-hidden="true">¬ß</a> Dabble in Babel</h4>
<p>Babel is used in the <a href="https://babeljs.io/users/">wild</a> by the likes of Facebook, Netflix, Airbnb and Yahoo. As mentioned earlier, we will use Babel to transpile our ES6/7 code. This is accomplished from within webpack via the <code>babel-loader</code>. Our config looks for files ending in <code>.js</code> in the <code>./src</code> directory and loads them with <code>babel-loader</code>. Before you can use it though, you need to install it:</p>
<pre><code class="language-sh">npm install -D babel-loader babel-core
</code></pre>
<p>This installs <code>babel-loader</code>, again, as a <strong>development dependency</strong>. <code>babel-loader</code> in turn lists <code>babel-core</code> as its peer dependency which needs to be installed. This is the babel compiler core which exposes the Node.js API. At a high level, Babel runs in three stages: parsing, transforming, and generation. Out of the box, Babel does not transform anything. It just parses code and spits it out exactly the same. To make Babel transform code, we need to (you guessed it!) install plugins.</p>
<p>If you updated your Node.js installation to the latest version, as mentioned earlier, you‚Äôd have probably ended up with 6.2.2+ which supports <a href="http://node.green/">96%</a> of the ES2015(ES6) features. V8 hasn‚Äôt landed <a href="https://bugs.chromium.org/p/v8/issues/detail?id=1569">support</a> for ES6 native modules yet but Webpack 2+ takes care of that for us. It understands native ES6 modules which are statically analyzable. This helps in getting rid of extraneous exports from our build aka dead code elimination. Webpack accomplishes this with <a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html">tree-shaking</a>. Sweet! So we just need to worry about those <em>async</em> functions that Node.js 6.2.2 doesn‚Äôt understand.</p>
<p>The plugin we need is <a href="http://babeljs.io/docs/plugins/transform-async-to-generator/">babel-plugin-transform-async-to-generator</a>. The name is more than self-explanatory. Babel can be configured to use these plugins via the <code>.babelrc</code> file which lives in the root of our repository. Our tiny <code>.babelrc</code> file looks like so:</p>
<pre><code class="language-json5">{
  <span class="hljs-attr">"plugins"</span>: [<span class="hljs-string">"transform-async-to-generator"</span>]
}
</code></pre>
<p>Obviously, it needs to be installed as a <strong>development dependency</strong> before you
can use it:</p>
<pre><code class="language-sh">npm install -D babel-plugin-transform-async-to-generator
</code></pre>
<h4 id="catch-em-all-with-koa"><a class="header-anchor" href="#catch-em-all-with-koa" aria-hidden="true">¬ß</a> Catch ‚Äôem All With Koa</h4>
<p>With our build tools in place, we can start writing the server finally. As mentioned earlier, Koa is a very minimal framework and does not offer much out of the box. Everything in Koa is middleware and there are quite a few of them. We will be using Koa 2 which can be installed with the <code>next</code> dist-tag. Go ahead and install Koa and a couple of middleware like so:</p>
<pre><code class="language-sh">npm install -S koa@next koa-route@next koa-logger@next
</code></pre>
<p>For the purpose of this article, we will be mocking a database with the <a href="https://pokeapi.co/">Pokeapi</a>. Since Koa expects <code>xyz</code> to return a Promise in all <code>await xyz</code> expressions, we will make use of <a href="https://github.com/PokeAPI/pokedex-promise-v2">pokedex-promise-v2</a> which is simply a Promise based wrapper for the Pokeapi. Install it like so:</p>
<pre><code class="language-sh">npm install -S pokedex-promise-v2
</code></pre>
<p>We will abstract our database logic into separate modules. Go ahead and create
two new files in the <code>./src</code> directory.</p>
<pre><code class="language-sh"><span class="hljs-built_in">cd</span> src
touch pokemondb.js stats.js
</code></pre>
<ul>
<li><strong>pokemondb.js</strong> just exports a function that takes a string as an argument
and returns a Promise.</li>
</ul>
<pre><code class="language-js"><span class="hljs-keyword">import</span> Pokedex <span class="hljs-keyword">from</span> <span class="hljs-string">'pokedex-promise-v2'</span>;

<span class="hljs-keyword">const</span> P = <span class="hljs-keyword">new</span> Pokedex();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span> (<span class="hljs-params">pokemon</span>) </span>{
   <span class="hljs-keyword">return</span> P.getPokemonByName(pokemon);
};
</code></pre>
<ul>
<li><strong>stats.js</strong> also exports a function that takes an object as an argument and
return a string.</li>
</ul>
<pre><code class="language-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stats</span> (<span class="hljs-params">data</span>) </span>{
   <span class="hljs-keyword">return</span> (
      <span class="hljs-string">`
      NAME   : <span class="hljs-subst">${data.name}</span>
      HEIGHT : <span class="hljs-subst">${data.height}</span>
      WEIGHT : <span class="hljs-subst">${data.weight}</span>
      BASE XP: <span class="hljs-subst">${data.base_experience}</span>
      `</span>
   );
}
</code></pre>
<p>With our mock database and helper method in place, we can go ahead and consume
it in our server. The <code>index.js</code> looks like so:</p>
<pre><code class="language-js"><span class="hljs-keyword">import</span> get <span class="hljs-keyword">from</span> <span class="hljs-string">'./pokemondb'</span>;
<span class="hljs-keyword">import</span> stats <span class="hljs-keyword">from</span> <span class="hljs-string">'./stats'</span>;
<span class="hljs-keyword">import</span> Koa <span class="hljs-keyword">from</span> <span class="hljs-string">'koa'</span>;
<span class="hljs-keyword">import</span> route <span class="hljs-keyword">from</span> <span class="hljs-string">'koa-route'</span>;
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'koa-logger'</span>;

<span class="hljs-keyword">const</span> getPokemonFromAPI = <span class="hljs-keyword">async</span> (ctx, name) =&gt; {
  <span class="hljs-keyword">try</span> {
   <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> get(name);
   ctx.body = stats(data);
  } <span class="hljs-keyword">catch</span> (err) {
    ctx.throw(<span class="hljs-number">404</span>, err.error.detail);
  }
};

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Koa();
app.use(logger())
   .use(route.get(<span class="hljs-string">'/:name'</span>, getPokemonFromAPI))
   .listen(<span class="hljs-number">8000</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Listening on Port 8000'</span>);
</code></pre>
<p>The main point of interest here is the asynchronous <code>getPokemonFromAPI</code>
function. If you have done asynchronous programming in JavaScript before, you
must be aware of the <a href="http://callbackhell.com/">callback pattern and the problems it
brings</a>. If that is indeed the case, this function
should make you shed tears of joy. Note how this idiom lets us handle errors
gracefully in a try-catch block.</p>
<p>We will be using some neat npm run scripts to build and start our server.</p>
<pre><code class="language-sh"><span class="hljs-string">'scripts'</span>: {
  <span class="hljs-string">'clean'</span>: <span class="hljs-string">'rm -rf ./build'</span>,
  <span class="hljs-string">'build:prod'</span>: <span class="hljs-string">'npm run clean &amp;&amp; `npm bin`/webpack --env.prod'</span>,
  <span class="hljs-string">'watch'</span>: <span class="hljs-string">'npm run clean &amp;&amp; `npm bin`/webpack --watch --verbose'</span>,
  <span class="hljs-string">'start'</span>: <span class="hljs-string">'node ./build/server.js'</span>
}
</code></pre>
<p>Besides <code>start</code> and <code>clean</code>, which are trivial, we will use <code>build:prod</code> to make
a production build by passing <code>prod</code> via <code>--env</code> as mentioned earlier.</p>
<p>Go ahead and run the following in the root of your repository and open
<code>localhost:8000</code> in your browser.</p>
<pre><code class="language-sh">npm run build:prod
npm start
</code></pre>
<p>Well, there isn‚Äôt much to see because our server returned a 404.</p>
<figure><img src="./404.png" alt="Oh no!"><figcaption>Oh no!</figcaption></figure>
<p>This is understandable since we don‚Äôt have a route handler attached to our base
URL: <code>‚Äò/‚Äô</code>. This prompts Koa to return it‚Äôs default 404 message. Go ahead and
fix this by adding that route-handler to our <code>index.js</code> file.</p>
<figure><img src="./routehandler.png" alt=""></figure>
<p>Before you can see these changes reflected, you need to build the bundle again.
This is a bummer. We want our bundle to be regenerated every time we make
changes to our source files. Our <code>watch</code> script takes care of that by running
Webpack in development mode with the <code>--watch</code> option. Webpack will now watch
our files and generate a new bundle when we save changes. Run the <code>watch</code> script
like so:</p>
<pre><code class="language-sh">npm run watch
</code></pre>
<p>Webpack won‚Äôt exit since it keeps watching the files. Open a new shell in the
root of your repository to start the server.</p>
<pre><code class="language-sh">npm start <span class="hljs-comment"># in new shell tab</span>
</code></pre>
<p>If you see an error like:</p>
<pre><code class="language-sh">Error: listen EADDRINUSE :::8000
</code></pre>
<p>Make sure you exit all currently running servers (Ctrl+C) before starting a
new one. Refresh your browser and you should see:</p>
<figure><img src="./catchemall.png" alt=""></figure>
<p>We can get stats for any Pokemon by pointing our browser to the respective name
like so:</p>
<figure><img src="./stats.png" alt=""></figure>
<h4 id="do-you-even-hmr"><a class="header-anchor" href="#do-you-even-hmr" aria-hidden="true">¬ß</a> Do You Even HMR?</h4>
<p>If you play around with what we have so far, you‚Äôll tend to notice that our workflow is still a little complicated. We need to manually restart our server whenever we make changes since a new bundle is generated. To get past that we may use a process manager (<a href="http://pm2.keymetrics.io/">pm2</a>, <a href="http://nodemon.io/">nodemon</a>, <a href="http://strong-pm.io/">StrongLoopPM</a>) to watch our files and trigger a webpack build before restarting our server. This definitely removes the hassle of doing it manually. However, it works well if we are not doing anything stateful or don‚Äôt care about losing state in our server code. Go ahead and take a look at <a href="https://medium.com/u/a3a8af6addc1">Dan Abramov</a>‚Äôs <a href="https://gaearon.github.io/react-hot-loader/">react-hot-loader</a> if this doesn‚Äôt make sense. Let us leverage Webpack‚Äôs <a href="https://webpack.github.io/docs/hot-module-replacement.html">Hot Module Replacement</a> API to hot patch our server side code. For now, we will restrict ourselves to the development environment.</p>
<p>Note that we are currently using <a href="https://github.com/webpack/webpack/blob/master/hot/poll.js">webpack/hot/poll</a> which polls the Node.js filestream (<code>fs</code>) every 1000 ms. In production we might want to use the more efficient <a href="https://github.com/webpack/webpack/blob/master/hot/signal.js">webpack/hot/signal</a> which listens on process events to check for updates. Creating a separate directory for the records Webpack will generate should also be a good idea.</p>
<p>The watch script needs to be modified to enable HMR. This can also be done by
using the <code>HotModuleReplacementPlugin</code> but don‚Äôt use both.</p>
<pre><code class="language-sh"><span class="hljs-string">'watch'</span>: <span class="hljs-string">'npm run clean &amp;&amp; `npm bin`/webpack --env.dev --watch -- verbose --hot'</span>
</code></pre>
<p>We don‚Äôt need to do much to handle the updated dependencies in our main
<code>index.js</code> file since we are using ES6 modules which are static in nature. The
following would suffice:</p>
<figure><img src="./hmr.png" alt=""></figure>
<p>Go ahead and run the <code>watch</code> script followed by the <code>start</code> script in another
tab as before. Make changes to the <code>stats.js</code> module and refresh your browser to
see them live <strong>without restarting the server</strong>. The GIF below illustrates this
in the terminal:</p>
<figure><img src="./final.gif" alt=""></figure>
<h4 id="fin"><a class="header-anchor" href="#fin" aria-hidden="true">¬ß</a> Fin?</h4>
<p>HMR is theoretically possible in production but has not been tested enough. It
is better to stick to a process manager when in production. On the development
end too however, we can take it one step further by handling the case where a
hot update fails or aborts. The server should appropriately restart in that
instance. Koa apps can be tested fluently with
<a href="https://github.com/visionmedia/supertest">supertest</a> which this repository will
implement soon.</p>
<figure><img src="./webpack-build.png" alt=""></figure>
<p>Originally <img class="emoji" draggable="false" alt="üìù" src="https://twemoji.maxcdn.com/2/svg/1f4dd.svg"> on <a href="https://medium.com/@f0rr0/kickback-with-koa-webpack-a51d7e5d7911">Medium</a>.</p>
</div></article><aside class="post-footer" data-reactid="26"><ul data-reactid="27"><li data-reactid="28"><div class="SocialMediaShareButton SocialMediaShareButton--twitter share-icons" data-reactid="29"><div style="width:32px;height:32px;" data-reactid="30"><svg viewBox="0 0 64 64" fill="white" width="32" height="32" class="social-icon social-icon--twitter " data-reactid="31"><g data-reactid="32"><circle cx="32" cy="32" r="31" fill="#00aced" data-reactid="33"></circle></g><g data-reactid="34"><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" data-reactid="35"></path></g></svg></div></div></li><li data-reactid="36"><div class="SocialMediaShareButton SocialMediaShareButton--facebook share-icons" data-reactid="37"><div style="width:32px;height:32px;" data-reactid="38"><svg viewBox="0 0 64 64" fill="white" width="32" height="32" class="social-icon social-icon--facebook " data-reactid="39"><g data-reactid="40"><circle cx="32" cy="32" r="31" fill="#3b5998" data-reactid="41"></circle></g><g data-reactid="42"><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" data-reactid="43"></path></g></svg></div></div></li></ul><!-- react-empty: 44 --><hr data-reactid="45"/><div class="bio" data-reactid="46"><img class="avatar" alt="avatar" src="/423d290eaf378bf7e0361ddf2a3ed695.jpeg" data-reactid="47"/><p class="intro" data-reactid="48">Written by <a href='/about/'>Siddharth Jain</a> &mdash; an open source developer interested in minimal design, advanced JavaScript and everything &lambda;. He is currently <a href='/hire'>available</a> for contract development on a project basis.</p></div></aside></section><footer data-reactid="49"><section data-reactid="50"><p data-reactid="51"><a href="mailto:sid26@ucla.edu" data-reactid="52"><span class="footer-icon" style="background-image:url(/icons/send.svg);" data-reactid="53"></span><!-- react-text: 54 --> sid26@ucla.edu<!-- /react-text --></a></p><ul data-reactid="55"><li data-reactid="56"><a rel="noopener noreferrer" target="__blank" href="//facebook.com/f0rr0" data-reactid="57"><span class="footer-icon" style="background-image:url(/icons/facebook.svg);" data-reactid="58"></span></a></li><li data-reactid="59"><a rel="noopener noreferrer" target="__blank" href="//twitter.com/f0rr0" data-reactid="60"><span class="footer-icon" style="background-image:url(/icons/twitter.svg);" data-reactid="61"></span></a></li><li data-reactid="62"><a rel="noopener noreferrer" target="__blank" href="//github.com/f0rr0" data-reactid="63"><span class="footer-icon" style="background-image:url(/icons/github.svg);" data-reactid="64"></span></a></li><li data-reactid="65"><a rel="noopener noreferrer" target="__blank" href="//linkedin.com/in/f0rr0" data-reactid="66"><span class="footer-icon" style="background-image:url(/icons/linkedin.svg);" data-reactid="67"></span></a></li><li data-reactid="68"><a rel="noopener noreferrer" target="__blank" href="//medium.com/@f0rr0" data-reactid="69"><span class="footer-icon" style="background-image:url(/icons/medium.svg);" data-reactid="70"></span></a></li><li data-reactid="71"><a rel="noopener noreferrer" target="__blank" href="//open.spotify.com/user/sidjain95" data-reactid="72"><span class="footer-icon" style="background-image:url(/icons/spotify.svg);" data-reactid="73"></span></a></li><li data-reactid="74"><a rel="noopener noreferrer" target="__blank" href="//www.last.fm/user/sidjain26" data-reactid="75"><span class="footer-icon" style="background-image:url(/icons/lastfm.svg);" data-reactid="76"></span></a></li><li style="padding-left:0;" data-reactid="77"><a rel="noopener noreferrer" target="__blank" href="//goodreads.com/f0rr0" data-reactid="78"><span class="footer-icon" style="background-image:url(/icons/goodreads.svg);" data-reactid="79"></span></a></li></ul></section></footer></main></div><script async="" src="/bundle.js?t=1475050453332"></script></body></html>